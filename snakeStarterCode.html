<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
      body {
        background: black;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      canvas {
        border: 1px solid white;
      }
    </style>
  </head>
  <body onload="set(speed)" style="flex:1; flex-direction: column">
    <div>
      <span
        id="spanScore"
        style="color:#fff; margin-left: 0px; margin-right: 100px; font-size:30px;"
        >Score 0</span
      >
      <span
        id="spanLevelCount"
        style="color:#fff; margin-left: 100px; margin-right: 0px; font-size:30px; "
        >Level 1</span
      >
    </div>
    <div>
      <canvas width="480" height="480" id="game"></canvas>
    </div>
    <script>
      // let applex = 320,appley = 320;
      let scoreContainer = document.getElementById("spanScore");
      let levelContainer = document.getElementById("spanLevelCount");
      var canvas = document.getElementById("game");
      var context = canvas.getContext("2d");
      var grid = 16;
      var count = 0;
      let dx = grid,
        dy = 0;
      let score = 0;
      let level = 1;
      let speed = 300;
      let levelParameter = 5;

      //TODO: check to avoid apple over snake
      var snake = {
        x: 160,
        y: 160,
        cells: [{ x: 160, y: 160 }, { x: 144, y: 160 }]
      };

      var apple = {
        x: 320,
        y: 320
      };

      var wall = {
        x: 80,
        y: 80,
        cells: [
          { x: 80, y: 80 },
          { x: 80, y: 64 },
          { x: 80, y: 48 },
          { x: 80, y: 32 },
          { x: 80, y: 16 }
        ]
      };

      // draw apple
      function drawApple() {
        context.fillStyle = "red";
        context.fillRect(apple.x, apple.y, grid - 1, grid - 1);
      }
      drawApple();

      // draw snake
      function drawSnake() {
        context.fillStyle = "green";
        for (let i = 0; i < snake.cells.length; i++)
          if (i == 0) {
            context.fillStyle = "blue";
            context.fillRect(
              snake.cells[i].x,
              snake.cells[i].y,
              grid - 1,
              grid - 1
            );
          } else {
            context.fillStyle = "green";
            context.fillRect(
              snake.cells[i].x,
              snake.cells[i].y,
              grid - 1,
              grid - 1
            );
          }
      }
      drawSnake(); // for initial snake

      function generateRandomApple() {
        apple.x = Math.floor(Math.random() * 360);
        if (apple.x < 16) {
          generateRandomApple();
        }
        let extra = apple.x % 16;
        apple.x = apple.x - extra;
        for (let i = 0; i < snake.cells.length; i++) {
          if (snake.cells[i].x == apple.x) {
            generateRandomApple();
            break;
          }
        }

        apple.y = apple.x;
        console.log(apple.x, apple.y);
        // drawApple();../components/courseComponents/Databases.js
      }

      function moveSnake(dx, dy) {
        // ALways adding one at front and removing thr last while moving normallly
        console.log(snake.x, snake.y);
        snake.x += dx;
        snake.y += dy;
        // console.log(snake.x, snake.y);
        snakeTouchesWall();
        checkSnakeEatsBody();
        if (snake.x == apple.x && snake.y == apple.y) {
          snake.cells.unshift({ x: snake.x, y: snake.y }); // Insert at 0th position
          generateRandomApple();
          setScore();
          drawSnake();
         
          if (level == 3) {
          }
        } else {
          snake.cells.pop(); // remove the last element
          snake.cells.unshift({ x: snake.x, y: snake.y }); // Insert at 0th position
          console.log(snake.cells.length);
          drawSnake();
        }
      }

      function snakeTouchesWall() {
        if (snake.x == 480) {
          snake.x = 0;
        } else if (snake.x == 0) {
          snake.x = 480;
        }
        if (snake.y == 480) {
          snake.y = 0;
        } else if (snake.y == 0) {
          snake.y = 480;
        }
      }

      function checkSnakeEatsBody() {
        for (let i = 0; i < snake.cells.length; i++) {
          if (snake.cells[i].x == snake.x && snake.cells[i].y == snake.y) {
            alert("game over");
            clear();
          }
        }
      }

      function incrementLevel() {
        level++;
        levelContainer.innerHTML = `Level ${level}`;
        checkLevel();
      }

      drawWalls = () => {
        for (let i = 0; i < wall.cells.length; i++) {
          context.fillStyle = "green";
          context.fillRect(
            wall.cells[i].x,
            wall.cells[i].y,
            grid - 1,
            grid - 1
          );
        }
      };

      function checkLevel() {
        if (level == 2) {
          set(150);
        }
        if (level == 3) {
          // drawWalls();
        }
        if (level == 4) {
          speed = 50;
        }
      }

      function setScore() {
        score++;
        if (score % levelParameter == 0) {
          incrementLevel();
        }
        console.log(scoreContainer.innerHTML);
        scoreContainer.innerHTML = `Score ${score}`;
      }

      function clear() {
        clearInterval(interval);
      }

      set = speed => {
        interval = setInterval(() => {
          context.clearRect(0, 0, canvas.width, canvas.height); // Clear the Canvas
          moveSnake(dx, dy);
          drawApple();
          console.log(speed);
        }, speed);
      };

      let flag = false;
      // listen to keyboard events to move the snake
      document.addEventListener("keydown", function(e) {
        // left arrow key
        if (e.keyCode == 37) {
          dx = -grid;
          dy = 0;
          console.log("left");
        }
        // up arrow key
        else if (e.keyCode == 38) {
          dy = -grid;
          dx = 0;
          console.log("up");
        }
        // right arrow key
        else if (e.keyCode == 39) {
          dx = grid;
          dy = 0;
          console.log("right");
        }
        // down arrow key
        else if (e.keyCode == 40) {
          dy = grid;
          dx = 0;
          console.log("down");
        }
        // context.clearRect(0, 0, canvas.width, canvas.height); // Clear the Canvas
        // moveSnake(dx, dy);
        // drawApple();
      });
    </script>
  </body>
</html>
